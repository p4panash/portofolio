name: Update Playwright Snapshots

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-snapshots:
    # Only run on PR comments that contain '/update-snapshots'
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/update-snapshots')
    runs-on: ubuntu-latest
    steps:
      - name: React to comment and post initial status
        id: initial-comment
        uses: actions/github-script@v7
        with:
          script: |
            // React with rocket emoji
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

            // Post initial comment with workflow link
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const comment = await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Updating Playwright snapshots...\n\n[View workflow run](${runUrl})`
            });

            core.setOutput('comment_id', comment.data.id);

      - name: Get PR branch
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-branch.outputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright Chromium browser
        run: pnpm exec playwright install chromium --with-deps

      - name: Build application
        env:
          PUBLIC_MAPBOX_TOKEN: ${{ secrets.PUBLIC_MAPBOX_TOKEN }}
        run: pnpm run build

      - name: Clean any existing changes before snapshot update
        run: |
          git reset --hard HEAD
          git clean -fd

      - name: Update snapshots
        run: pnpm exec playwright test --project=chromium --update-snapshots || true

      - name: Commit and push updated snapshots
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A tests/
          if git diff --staged --quiet; then
            echo "No snapshot changes detected"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            # Amend the previous snapshot commit if it exists, otherwise create new
            if git log -1 --pretty=%B | grep -q "Update Playwright snapshots from CI"; then
              git commit --amend --no-edit
              git push --force-with-lease
            else
              git commit -m "Update Playwright snapshots from CI

          Triggered by: ${{ github.event.comment.user.login }}"
              git push
            fi
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Update comment with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const hasChanges = process.env.HAS_CHANGES === 'true';
            const commentId = '${{ steps.initial-comment.outputs.comment_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const message = hasChanges
              ? '‚úÖ Snapshots have been updated and committed to this PR!'
              : '‚ÑπÔ∏è No snapshot changes were needed.';

            // Update the initial comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: `${message}\n\n[View workflow run](${runUrl})`
            });
